name: Update AdGuard Rules

on:
  schedule:
    - cron: '0 3 * * *' # æ¯å¤©UTCæ—¶é—´3ç‚¹è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…³é”®ï¼šæˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™

    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆéœ€è¦åŒ…å« write æƒé™ï¼‰
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # æ£€å‡ºåˆ° `rules` åˆ†æ”¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŸºäº main åˆ›å»º
        ref: rules

    # 2. è®¾ç½®Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. è¿è¡Œè„šæœ¬ï¼Œç”Ÿæˆè§„åˆ™æ–‡ä»¶
    - name: Run scripts to generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        echo "è§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # 5. æäº¤å¹¶æ¨é€åˆ° `rules` åˆ†æ”¯
    - name: Commit and Push to rules branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶ç”Ÿæˆ
        if [ -z "$(git status --porcelain rules/)" ]; then
          echo "æ²¡æœ‰æ–°çš„è§„åˆ™æ–‡ä»¶éœ€è¦æäº¤ã€‚"
        else
          # æ·»åŠ æ‰€æœ‰è§„åˆ™æ–‡ä»¶
          git add rules/
          git commit -m "ğŸ”„ Auto-update rules $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:rules
          echo "âœ… è§„åˆ™æ–‡ä»¶å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€è‡³ 'rules' åˆ†æ”¯ã€‚"
        fi