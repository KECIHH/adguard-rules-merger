name: Update AdGuard Rules

on:
  schedule:
    # UTC 02:00 = åŒ—äº¬æ—¶é—´ 10:00
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # 1ï¸âƒ£ è®¾ç½®æ—¶åŒºï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - name: Set Beijing Timezone
      uses: szenius/set-timezone@v1.2
      with:
        timezoneLinux: "Asia/Shanghai"

    # 2ï¸âƒ£ æ£€å‡º main åˆ†æ”¯ï¼ˆè„šæœ¬æ‰€åœ¨ï¼‰
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main

    # 3ï¸âƒ£ åˆ›å»º rules è¾“å‡ºç›®å½•ï¼ˆä¸ checkout åˆ†æ”¯ï¼Œé¿å…æŠ¥é”™ï¼‰
    - name: Prepare rules output directory
      run: |
        mkdir -p rules-output

    # 4ï¸âƒ£ è®¾ç½® Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # 5ï¸âƒ£ å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 6ï¸âƒ£ ç”Ÿæˆè§„åˆ™
    - name: Generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        python scripts/optimize_rules.py
        echo "è§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # 7ï¸âƒ£ æ•´ç†è§„åˆ™æ–‡ä»¶ï¼ˆå½’æ¡£ / latest / indexï¼‰
    - name: Prepare and Organize Rules
      run: |
        cd rules-output

        TODAY=$(date +'%Y-%m-%d')

        mkdir -p archive/$TODAY/full
        mkdir -p archive/$TODAY/lite
        mkdir -p latest/full
        mkdir -p latest/lite

        cp ../rules/merged_all.txt archive/$TODAY/full/
        cp ../rules/merged_lite.txt archive/$TODAY/lite/
        cp ../rules/merge_stats.txt archive/$TODAY/full/ 2>/dev/null || true
        cp ../rules/optimization_stats.txt archive/$TODAY/lite/ 2>/dev/null || true

        # æ›´æ–° latest
        cp archive/$TODAY/full/merged_all.txt latest/full/
        cp archive/$TODAY/lite/merged_lite.txt latest/lite/

        # æ¸…ç† 30 å¤©å‰å†å²
        find archive -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \; 2>/dev/null || true

        # ç”Ÿæˆ index.md
        echo "# ğŸ“ AdGuard è§„åˆ™ä»“åº“ç´¢å¼•" > index.md
        echo "" >> index.md
        echo "## ğŸš€ å¿«é€Ÿè®¢é˜…" >> index.md
        echo "" >> index.md
        echo "- **ç²¾ç®€ç‰ˆ**: [latest/lite/merged_lite.txt](./latest/lite/merged_lite.txt)" >> index.md
        echo "- **å®Œæ•´ç‰ˆ**: [latest/full/merged_all.txt](./latest/full/merged_all.txt)" >> index.md
        echo "" >> index.md
        echo "## ğŸ“… ä»Šæ—¥ç”Ÿæˆ" >> index.md
        echo "" >> index.md
        echo "| ç‰ˆæœ¬ | æ–‡ä»¶ |" >> index.md
        echo "| --- | --- |" >> index.md
        echo "| å®Œæ•´ç‰ˆ | archive/$TODAY/full/merged_all.txt |" >> index.md
        echo "| ç²¾ç®€ç‰ˆ | archive/$TODAY/lite/merged_lite.txt |" >> index.md

        echo "æ–‡ä»¶æ•´ç†å®Œæˆã€‚"

    # 8ï¸âƒ£ æäº¤å¹¶æ¨é€åˆ° rules åˆ†æ”¯ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    - name: Commit and Push to rules branch
      run: |
        cd rules-output

        git init
        git remote add origin https://github.com/${{ github.repository }}.git

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git checkout -B rules
        git add .

        if git diff --cached --quiet; then
          echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤ã€‚"
        else
          git commit -m "ğŸ“¦ Auto-update rules $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git rules
          echo "âœ… å·²æ¨é€åˆ° rules åˆ†æ”¯"
        fi
