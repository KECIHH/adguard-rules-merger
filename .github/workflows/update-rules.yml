name: Update AdGuard Rules

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    # 1. æˆäºˆå†™å…¥æƒé™ [citation:8][citation:9]
    permissions:
      contents: write

    steps:
    # 2. é¦–å…ˆï¼Œæ£€å‡ºä¸»åˆ†æ”¯ï¼ˆåŒ…å«ä½ çš„è„šæœ¬ï¼‰
    - name: Checkout main branch (for scripts)
      uses: actions/checkout@v4
      with:
        ref: main # æ˜ç¡®æŒ‡å®šæ£€å‡ºä¸»åˆ†æ”¯
        token: ${{ secrets.GITHUB_TOKEN }}

    # 3. è®¾ç½®ç¯å¢ƒå¹¶è¿è¡Œè„šæœ¬ (å’Œä¹‹å‰ä¸€æ ·)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run scripts to generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        echo "è§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # 4. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å‡†å¤‡å¹¶æ¨é€åˆ° rules åˆ†æ”¯
    - name: Commit and Push to rules branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # å¯é€‰ï¼šç§»é™¤å¯èƒ½å¹²æ‰°è®¤è¯çš„é¢å¤–å¤´éƒ¨ [citation:5]
        git config --global --unset-all http.https://github.com/.extraheader || true

        # æ·»åŠ ç”Ÿæˆçš„æ‰€æœ‰è§„åˆ™æ–‡ä»¶
        git add -f rules/

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
        if [ -z "$(git status --porcelain rules/)" ]; then
          echo "æ²¡æœ‰æ–°çš„è§„åˆ™æ–‡ä»¶éœ€è¦æäº¤ã€‚"
          exit 0
        fi

        # æäº¤æ›´æ”¹
        git commit -m "ğŸ”„ Auto-update rules $(date +'%Y-%m-%d %H:%M:%S')"

        # å¼ºåˆ¶æ¨é€åˆ° rules åˆ†æ”¯ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰
        git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:rules
        echo "âœ… è§„åˆ™æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ 'rules' åˆ†æ”¯ã€‚"