name: Update AdGuard Rules

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # æ–°å¢æ­¥éª¤ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒçš„æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
    - name: Set Beijing Timezone
      uses: szenius/set-timezone@v1.2
      with:
        timezoneLinux: "Asia/Shanghai"

    # 1. æ£€å‡ºä¸»åˆ†æ”¯ï¼ˆåŒ…å«ä½ çš„è„šæœ¬ï¼‰
    - name: Checkout main branch (for scripts)
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. è®¾ç½®ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. è¿è¡Œä¸»è„šæœ¬ï¼Œç”Ÿæˆå®Œæ•´ç‰ˆè§„åˆ™
    - name: Run scripts to generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        echo "å®Œæ•´ç‰ˆè§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # === ä»¥ä¸‹æ˜¯æ–°å¢æ­¥éª¤ï¼Œç”¨äºç”Ÿæˆå’Œå‘å¸ƒç²¾ç®€ç‰ˆ ===
    # 4.5 ç”Ÿæˆç²¾ç®€ç‰ˆè§„åˆ™ï¼ˆä¾èµ–äºç¬¬4æ­¥ç”Ÿæˆçš„å®Œæ•´ç‰ˆè§„åˆ™ï¼‰
    - name: Generate lite (optimized) rules
      run: |
        echo "å¼€å§‹ä¸ºéšèº«WiFiç”Ÿæˆç²¾ç®€ç‰ˆè§„åˆ™..."
        python scripts/optimize_rules.py
        echo "ç²¾ç®€ç‰ˆè§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # 4.6 æäº¤å¹¶æ¨é€åˆ° rules-lite åˆ†æ”¯
    - name: Commit and Push to rules-lite branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # æ·»åŠ ç”Ÿæˆçš„ç²¾ç®€ç‰ˆè§„åˆ™æ–‡ä»¶
        git add -f rules/merged_lite.txt
        git add -f rules/merged_dns_lite.txt 2>/dev/null || true

        # æ£€æŸ¥æ˜¯å¦æœ‰ç²¾ç®€ç‰ˆæ–‡ä»¶éœ€è¦æäº¤
        if [ -z "$(git status --porcelain rules/merged_lite.txt)" ]; then
          echo "æ²¡æœ‰æ–°çš„ç²¾ç®€ç‰ˆè§„åˆ™æ–‡ä»¶éœ€è¦æäº¤ã€‚"
        else
          git commit -m "ğŸ“¦ Lite: Auto-update rules $(date +'%Y-%m-%d %H:%M:%S')"
          # æ¨é€åˆ°ä¸“é—¨å­˜æ”¾ç²¾ç®€ç‰ˆçš„ rules-lite åˆ†æ”¯
          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:rules-lite
          echo "âœ… ç²¾ç®€ç‰ˆè§„åˆ™æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ 'rules-lite' åˆ†æ”¯ã€‚"
        fi
    # === æ–°å¢æ­¥éª¤ç»“æŸ ===

    # 5. æäº¤å¹¶æ¨é€åˆ° rules åˆ†æ”¯ (åŸæœ‰æ­¥éª¤ï¼Œæ¨é€å®Œæ•´ç‰ˆ)
    - name: Commit and Push to rules branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # å¯é€‰ï¼šç§»é™¤å¯èƒ½å¹²æ‰°è®¤è¯çš„é¢å¤–å¤´éƒ¨
        git config --global --unset-all http.https://github.com/.extraheader || true

        # æ·»åŠ ç”Ÿæˆçš„æ‰€æœ‰è§„åˆ™æ–‡ä»¶ï¼ˆè¿™é‡Œä¸»è¦æ˜¯å®Œæ•´ç‰ˆï¼‰
        git add -f rules/

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¼šåŒ…å«ç²¾ç®€ç‰ˆï¼Œä½†å·²åœ¨ä¸Šä¸€æ­¥æäº¤ï¼‰
        if [ -z "$(git status --porcelain rules/)" ]; then
          echo "æ²¡æœ‰æ–°çš„è§„åˆ™æ–‡ä»¶éœ€è¦æäº¤ã€‚"
          exit 0
        fi

        # æäº¤æ›´æ”¹ (ä¸»è¦æäº¤å®Œæ•´ç‰ˆï¼Œç²¾ç®€ç‰ˆåœ¨ä¸Šä¸€æ­¥å·²å•ç‹¬æäº¤)
        # ç”±äºä¸Šä¸€æ­¥å·²ç»æäº¤äº†ç²¾ç®€ç‰ˆï¼Œè¿™é‡Œéœ€è¦é¿å…é‡å¤ã€‚
        # ä¸€ä¸ªç®€å•çš„åŠæ³•æ˜¯é‡ç½®å¹¶åªæ·»åŠ å®Œæ•´ç‰ˆç‰¹æœ‰çš„æ–‡ä»¶ã€‚
        git reset HEAD rules/ 2>/dev/null || true
        # æ˜ç¡®æ·»åŠ å®Œæ•´ç‰ˆæ–‡ä»¶ï¼ˆæ’é™¤ç²¾ç®€ç‰ˆï¼‰
        git add rules/merged_all.txt rules/merged_dns.txt
        
        # å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„å®Œæ•´ç‰ˆæ–‡ä»¶
        if git diff --staged --quiet; then
          echo "å®Œæ•´ç‰ˆè§„åˆ™æ–‡ä»¶æ²¡æœ‰å˜åŒ–ã€‚"
        else
          git commit -m "ğŸ”„ Full: Auto-update rules $(date +'%Y-%m-%d %H:%M:%S')"
          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:rules
          echo "âœ… å®Œæ•´ç‰ˆè§„åˆ™æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ 'rules' åˆ†æ”¯ã€‚"
        fi