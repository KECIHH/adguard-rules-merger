name: Update AdGuard Rules

on:
  schedule:
    # UTCæ—¶é—´å‡Œæ™¨2ç‚¹è¿è¡Œï¼Œå³åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Set Beijing Timezone
      uses: szenius/set-timezone@v1.2
      with:
        timezoneLinux: "Asia/Shanghai"

    # 1. æ£€å‡ºä¸»åˆ†æ”¯ï¼ˆåŒ…å«è„šæœ¬ï¼‰åˆ°é»˜è®¤å·¥ä½œåŒº
    - name: Checkout main branch (scripts)
      uses: actions/checkout@v4
      with:
        ref: main

    # 2. å¹¶è¡Œæ£€å‡º rules åˆ†æ”¯åˆ°å­ç›®å½•ï¼Œç”¨äºåç»­æäº¤
    - name: Checkout rules branch (for output)
      uses: actions/checkout@v4
      with:
        ref: rules
        path: rules-output

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 3. åœ¨å·¥ä½œåŒºæ ¹ç›®å½•è¿è¡Œè„šæœ¬ç”Ÿæˆè§„åˆ™æ–‡ä»¶
    - name: Generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        python scripts/optimize_rules.py
        echo "æ‰€æœ‰è§„åˆ™ç”Ÿæˆå®Œæˆã€‚"

    # 4. åœ¨ rules-output ç›®å½•ä¸­æ•´ç†å¹¶å½’æ¡£æ–‡ä»¶
    - name: Prepare and Organize Rules
      run: |
        # è¿›å…¥ rules åˆ†æ”¯çš„å·¥ä½œç›®å½•
        cd ./rules-output
        
        # === æ ¸å¿ƒä¼˜åŒ–ï¼šè‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰===
        echo "æ­£åœ¨æ¸…ç†30å¤©å‰çš„å†å²æ–‡ä»¶..."
        find . -maxdepth 1 -type d -name "20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]" -mtime +30 2>/dev/null | while read old_dir; do
          echo "åˆ é™¤å†å²ç›®å½•: $old_dir"
          rm -rf "$old_dir"
        done
        
        # è®¾ç½®æ—¥æœŸå˜é‡
        TODAY=$(date +'%Y-%m-%d')
        
        # ä¸ºä»Šå¤©çš„è§„åˆ™åˆ›å»ºæ—¥æœŸç›®å½•
        mkdir -p "./$TODAY/full"
        mkdir -p "./$TODAY/lite"
        
        # æ³¨æ„ï¼šä»å·¥ä½œåŒºæ ¹ç›®å½•å¤åˆ¶æ–°ç”Ÿæˆçš„æ–‡ä»¶åˆ° output ç›®å½•
        cp ../rules/merged_all.txt "./$TODAY/full/"
        cp ../rules/merged_lite.txt "./$TODAY/lite/"
        cp ../rules/merge_stats.txt "./$TODAY/full/" 2>/dev/null || true
        cp ../rules/optimization_stats.txt "./$TODAY/lite/" 2>/dev/null || true
        
        # --- ç”Ÿæˆæˆ–æ›´æ–°ç´¢å¼•æ–‡ä»¶ (index.md) ---
        # å¦‚æœç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒå¹¶å†™å…¥åˆå§‹å†…å®¹
        if [ ! -f "./index.md" ]; then
          echo "# ğŸ“ AdGuard è§„åˆ™ä»“åº“ç´¢å¼•" > ./index.md
          echo "" >> ./index.md
          echo "æ­¤åˆ†æ”¯åŒ…å«è‡ªåŠ¨ç”Ÿæˆçš„ AdGuard è§„åˆ™æ–‡ä»¶ï¼ŒæŒ‰æ—¥æœŸå’Œç‰ˆæœ¬åˆ†ç±»å½’æ¡£ã€‚" >> ./index.md
          echo "" >> ./index.md
          echo "**å­˜æ¡£ç­–ç•¥**ï¼šè‡ªåŠ¨ä¿ç•™æœ€è¿‘30å¤©çš„å†å²æ–‡ä»¶ï¼Œæ›´æ—©çš„æ–‡ä»¶å°†è¢«è‡ªåŠ¨æ¸…ç†ã€‚" >> ./index.md
          echo "" >> ./index.md
          echo "## ğŸ“… æœ€æ–°æ–‡ä»¶ (é€‚ç”¨äºå¿«é€Ÿä½¿ç”¨)" >> ./index.md
          echo "" >> ./index.md
          echo "| ç‰ˆæœ¬ | æ–‡ä»¶ | è§„åˆ™æ•°é‡ | å¤§å° | ç”Ÿæˆæ—¶é—´ |" >> ./index.md
          echo "| :--- | :--- | :--- | :--- | :--- |" >> ./index.md
        fi
        
        # è·å–æ–‡ä»¶çš„è§„åˆ™è¡Œæ•° (è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ)
        FULL_COUNT=$(grep -c -v -E '^!|^$' "./$TODAY/full/merged_all.txt" 2>/dev/null || echo "N/A")
        LITE_COUNT=$(grep -c -v -E '^!|^$' "./$TODAY/lite/merged_lite.txt" 2>/dev/null || echo "N/A")
        
        # è·å–æ–‡ä»¶å¤§å°
        FULL_SIZE=$(du -h "./$TODAY/full/merged_all.txt" 2>/dev/null | cut -f1)
        LITE_SIZE=$(du -h "./$TODAY/lite/merged_lite.txt" 2>/dev/null | cut -f1)
        
        # ç”Ÿæˆæ—¶é—´æˆ³
        TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
        
        # é‡å»ºç´¢å¼•æ–‡ä»¶
        echo "# ğŸ“ AdGuard è§„åˆ™ä»“åº“ç´¢å¼•" > ./index.md
        echo "" >> ./index.md
        echo "æ­¤åˆ†æ”¯åŒ…å«è‡ªåŠ¨ç”Ÿæˆçš„ AdGuard è§„åˆ™æ–‡ä»¶ï¼ŒæŒ‰æ—¥æœŸå’Œç‰ˆæœ¬åˆ†ç±»å½’æ¡£ã€‚" >> ./index.md
        echo "" >> ./index.md
        echo "**å­˜æ¡£ç­–ç•¥**ï¼šè‡ªåŠ¨ä¿ç•™æœ€è¿‘30å¤©çš„å†å²æ–‡ä»¶ï¼Œæ›´æ—©çš„æ–‡ä»¶å°†è¢«è‡ªåŠ¨æ¸…ç†ã€‚" >> ./index.md
        echo "" >> ./index.md
        echo "## ğŸ“… æœ€æ–°æ–‡ä»¶ (é€‚ç”¨äºå¿«é€Ÿä½¿ç”¨)" >> ./index.md
        echo "" >> ./index.md
        echo "| ç‰ˆæœ¬ | æ–‡ä»¶ | è§„åˆ™æ•°é‡ | å¤§å° | ç”Ÿæˆæ—¶é—´ |" >> ./index.md
        echo "| :--- | :--- | :--- | :--- | :--- |" >> ./index.md
        echo "| **å®Œæ•´ç‰ˆ** | [$TODAY/full/merged_all.txt](./$TODAY/full/merged_all.txt) | $FULL_COUNT æ¡ | $FULL_SIZE | $TIMESTAMP |" >> ./index.md
        echo "| **ç²¾ç®€ç‰ˆ** | [$TODAY/lite/merged_lite.txt](./$TODAY/lite/merged_lite.txt) | $LITE_COUNT æ¡ | $LITE_SIZE | $TIMESTAMP |" >> ./index.md
        
        echo "" >> ./index.md
        echo "## ğŸ“š å†å²å½’æ¡£ (æœ€è¿‘30å¤©)" >> ./index.md
        echo "" >> ./index.md
        echo "> æç¤ºï¼šç‚¹å‡»æ—¥æœŸå¯å±•å¼€æŸ¥çœ‹è¯¥æ—¥ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ã€‚" >> ./index.md
        echo "" >> ./index.md
        
        # æŒ‰æ—¥æœŸå€’åºåˆ—å‡ºæ‰€æœ‰å†å²æ—¥æœŸç›®å½•ï¼ˆæ¸…ç†åæœ€å¤š30ä¸ªï¼‰
        for DATE_DIR in $(ls -d 20*/ 2>/dev/null | sort -r); do
          DATE_DIR=${DATE_DIR%/} # ç§»é™¤ç»“å°¾çš„æ–œæ 
          if [ "$DATE_DIR" != "$TODAY" ]; then
            echo "<details>" >> ./index.md
            echo "<summary><b>$DATE_DIR</b></summary>" >> ./index.md
            echo "" >> ./index.md
            echo "| ç‰ˆæœ¬ | æ–‡ä»¶ | å¤§å° |" >> ./index.md
            echo "| :--- | :--- | :--- |" >> ./index.md
            if [ -f "./$DATE_DIR/full/merged_all.txt" ]; then
              SIZE=$(du -h "./$DATE_DIR/full/merged_all.txt" 2>/dev/null | cut -f1)
              echo "| å®Œæ•´ç‰ˆ | [$DATE_DIR/full/merged_all.txt](./$DATE_DIR/full/merged_all.txt) | $SIZE |" >> ./index.md
            fi
            if [ -f "./$DATE_DIR/lite/merged_lite.txt" ]; then
              SIZE=$(du -h "./$DATE_DIR/lite/merged_lite.txt" 2>/dev/null | cut -f1)
              echo "| ç²¾ç®€ç‰ˆ | [$DATE_DIR/lite/merged_lite.txt](./$DATE_DIR/lite/merged_lite.txt) | $SIZE |" >> ./index.md
            fi
            echo "" >> ./index.md
            echo "</details>" >> ./index.md
            echo "" >> ./index.md
          fi
        done
        
        echo "æ–‡ä»¶å·²æ•´ç†å¹¶ç´¢å¼•å®Œæˆã€‚"

    # 5. æäº¤å¹¶æ¨é€æ‰€æœ‰æ›´æ”¹åˆ° rules åˆ†æ”¯
    - name: Commit and Push All to rules branch
      run: |
        cd ./rules-output
        
        # é…ç½®Gitç”¨æˆ·
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„è§„åˆ™æ–‡ä»¶éœ€è¦æäº¤ã€‚"
        else
          # æäº¤å¹¶æ¨é€
          git commit -m "ğŸ“¦ Auto-update rules $(date +'%Y-%m-%d %H:%M:%S') [ä¿ç•™30å¤©å†å²]"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:rules
          echo "âœ… æ‰€æœ‰è§„åˆ™æ–‡ä»¶å·²æˆåŠŸæ¨é€è‡³ 'rules' åˆ†æ”¯ã€‚"
          echo "ğŸ“„ ç´¢å¼•é¡µé¢: https://github.com/${{ github.repository }}/blob/rules/index.md"
        fi