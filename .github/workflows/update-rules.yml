name: Update AdGuard Rules

on:
  # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“è§„åˆ™æºæˆ–è„šæœ¬å˜æ›´æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'sources/sources.txt'
      - 'scripts/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆå…³é”®ï¼šé…ç½®å†™æƒé™ï¼‰
    - name: Checkout code with write permission
      uses: actions/checkout@v3
      with:
        # æ˜¾å¼ä½¿ç”¨GITHUB_TOKENå¹¶å…è®¸åç»­æ­¥éª¤æ¨é€
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true # æ­¤è®¾ç½®è®©åç»­çš„git pushèƒ½ä½¿ç”¨åŒä¸€ä¸ªä»¤ç‰Œ
    
    # 2. è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # 3. å®‰è£…Pythonä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. è¿è¡Œè„šæœ¬ï¼Œç”Ÿæˆè§„åˆ™æ–‡ä»¶
    - name: Run scripts to generate rules
      run: |
        echo "å¼€å§‹æ›´æ–°è§„åˆ™..."
        python scripts/fetch_rules.py
        python scripts/merge_rules.py
        echo "è§„åˆ™æ›´æ–°å®Œæˆ"
    
    # 5. æäº¤å¹¶æ¨é€ç”Ÿæˆçš„æ–‡ä»¶åˆ°ä»“åº“
    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶ï¼Œ-f å‚æ•°ç¡®ä¿å³ä½¿è¢«.gitignoreä¹Ÿä¼šæ·»åŠ 
        git add -f rules/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹å¯ä»¥æäº¤
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤ã€‚"
        else
          # æäº¤å˜æ›´
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°è§„åˆ™ [$(date +'%Y-%m-%d %H:%M:%S')]"
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          git push
          echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€å˜æ›´åˆ°ä»“åº“ã€‚"
        fi
    
    # 6. (å¯é€‰) æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œä¿æŒä»“åº“æ•´æ´
    - name: Clean up temporary files (Optional)
      if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œæ¸…ç†
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf temp/ 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆã€‚"